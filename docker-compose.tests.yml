services:
  selenium-chrome:
    image: selenium/standalone-chrome:4.16.1
    shm_size: "2gb"
    ports:
      - "4444:4444"
    networks:
      - wpsite
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"]
      interval: 30s
      timeout: 10s
      retries: 12
      start_period: 30s

  selenium-tests:
    image: selenium-tests:latest
    build:
      context: .
      dockerfile: selenium/Dockerfile
    entrypoint: ["/bin/sh", "-lc"]
    working_dir: /work/selenium
    depends_on:
      selenium-chrome:
        condition: service_healthy
    environment:
      BASE_URL: http://wordpress
      SELENIUM_REMOTE_URL: http://selenium-chrome:4444/wd/hub
      NPM_CONFIG_UPDATE_NOTIFIER: "false"
      NPM_CONFIG_FUND: "false"
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_LOGLEVEL: "error"
    volumes:
      - ./:/work
    networks:
      - wpsite
    command:
      [
        "npm ci --no-audit --no-fund --loglevel=error --silent && mkdir -p /work/results/selenium && for f in tests/*.js; do REPORT_PATH=/work/results/selenium/$(basename \"$$f\" .js).xml node \"$$f\"; done"
      ]

  cypress-tests:
    image: cypress-tests:latest
    build:
      context: .
      dockerfile: cypress/Dockerfile
    entrypoint: ["/bin/sh", "-lc"]
    working_dir: /work/cypress
    environment:
      CYPRESS_BASE_URL: http://wordpress
      CYPRESS_NO_COMMAND_LOG: "1"
      CYPRESS_LOG_LEVEL: "error"
      NPM_CONFIG_UPDATE_NOTIFIER: "false"
      NPM_CONFIG_FUND: "false"
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_LOGLEVEL: "error"
    volumes:
      - ./:/work
    networks:
      - wpsite
    command:
      [
        "npm ci --no-audit --no-fund --loglevel=error --silent && mkdir -p /work/results/cypress && npx cypress run --quiet"
      ]

  playwright-tests:
    image: playwright-tests:latest
    build:
      context: .
      dockerfile: playwright/Dockerfile
    entrypoint: ["/bin/sh", "-lc"]
    working_dir: /work/playwright
    environment:
      BASE_URL: http://wordpress
      NPM_CONFIG_UPDATE_NOTIFIER: "false"
      NPM_CONFIG_FUND: "false"
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_LOGLEVEL: "error"
    volumes:
      - ./:/work
    networks:
      - wpsite
    command:
      [
        "npm ci --no-audit --no-fund --loglevel=error --silent && mkdir -p /work/results/playwright && npx playwright test --quiet"
      ]

networks:
  wpsite: {}
