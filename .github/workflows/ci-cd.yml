name: CI/CD - App + Tests

on:
  push:
    branches: [main]
    paths:
      - "app/**"
      - "selenium/**"
      - "cypress/**"
      - "playwright/**"
      - "docker-compose.tests.yml"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - "app/**"
      - "selenium/**"
      - "cypress/**"
      - "playwright/**"
      - "docker-compose.tests.yml"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  changes-detect:
    runs-on: ubuntu-latest
    outputs:
      app: ${{ steps.filter.outputs.app }}
      selenium: ${{ steps.filter.outputs.selenium }}
      cypress: ${{ steps.filter.outputs.cypress }}
      playwright: ${{ steps.filter.outputs.playwright }}
      compose: ${{ steps.filter.outputs.compose }}
      workflow: ${{ steps.filter.outputs.workflow }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            app:
              - 'app/**'
            selenium:
              - 'selenium/**'
            cypress:
              - 'cypress/**'
            playwright:
              - 'playwright/**'
            compose:
              - 'docker-compose.tests.yml'
            workflow:
              - '.github/workflows/ci-cd.yml'

  build-app:
    needs: [changes-detect]
    if: |
      needs.changes-detect.outputs.app == 'true' ||
      needs.changes-detect.outputs.selenium == 'true' ||
      needs.changes-detect.outputs.cypress == 'true' ||
      needs.changes-detect.outputs.playwright == 'true' ||
      needs.changes-detect.outputs.compose == 'true' ||
      needs.changes-detect.outputs.workflow == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Build app container
        run: |
          docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml pull --quiet

      - name: Smoke check app
        run: |
          docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml up -d --quiet-pull
          for i in {1..30}; do
            curl -fsS -o /dev/null http://localhost:8080/wp-login.php && exit 0
            sleep 5
          done
          echo "App did not become ready in time" >&2
          exit 1

      - name: Teardown app
        if: always()
        run: |
          docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml down --remove-orphans || true

  test-selenium:
    needs: [changes-detect, build-app]
    if: |
      needs.changes-detect.outputs.selenium == 'true' ||
      needs.changes-detect.outputs.compose == 'true' ||
      needs.changes-detect.outputs.workflow == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Start app stack
        run: docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml up -d --quiet-pull

      - name: Wait for app
        run: |
          for i in {1..30}; do
            curl -fsS -o /dev/null http://localhost:8080/wp-login.php && exit 0
            sleep 5
          done
          echo "App did not become ready in time" >&2
          exit 1

      - name: Start Selenium Chrome
        run: docker compose -f docker-compose.tests.yml up -d --quiet-pull selenium-chrome

      - name: Run Selenium tests
        run: docker compose -f docker-compose.tests.yml run --rm selenium-tests

      - name: Upload Selenium result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-selenium-tests
          path: results/selenium
          if-no-files-found: error

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker-compose.tests.yml down --remove-orphans || true
          if [ -f app/test-bookstore/docker-test-bookstore/docker-compose.yml ]; then
            docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml down --remove-orphans || true
          fi

  test-cypress:
    needs: [changes-detect, build-app]
    if: |
      needs.changes-detect.outputs.cypress == 'true' ||
      needs.changes-detect.outputs.compose == 'true' ||
      needs.changes-detect.outputs.workflow == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Start app stack
        run: docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml up -d --quiet-pull

      - name: Wait for app
        run: |
          for i in {1..30}; do
            curl -fsS -o /dev/null http://localhost:8080/wp-login.php && exit 0
            sleep 5
          done
          echo "App did not become ready in time" >&2
          exit 1

      - name: Run Cypress tests
        run: docker compose -f docker-compose.tests.yml run --rm cypress-tests

      - name: Upload Cypress result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-cypress-tests
          path: results/cypress
          if-no-files-found: error

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker-compose.tests.yml down --remove-orphans || true
          if [ -f app/test-bookstore/docker-test-bookstore/docker-compose.yml ]; then
            docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml down --remove-orphans || true
          fi

  test-playwright:
    needs: [changes-detect, build-app]
    if: |
      needs.changes-detect.outputs.playwright == 'true' ||
      needs.changes-detect.outputs.compose == 'true' ||
      needs.changes-detect.outputs.workflow == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Start app stack
        run: docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml up -d --quiet-pull

      - name: Wait for app
        run: |
          for i in {1..30}; do
            curl -fsS -o /dev/null http://localhost:8080/wp-login.php && exit 0
            sleep 5
          done
          echo "App did not become ready in time" >&2
          exit 1

      - name: Run Playwright tests
        run: docker compose -f docker-compose.tests.yml run --rm playwright-tests

      - name: Upload Playwright result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-playwright-tests
          path: results/playwright
          if-no-files-found: error

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker-compose.tests.yml down --remove-orphans || true
          if [ -f app/test-bookstore/docker-test-bookstore/docker-compose.yml ]; then
            docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml down --remove-orphans || true
          fi

  ci-summary:
    needs:
      - changes-detect
      - build-app
      - test-selenium
      - test-cypress
      - test-playwright
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate required jobs
        env:
          APP_CHANGED: ${{ needs.changes-detect.outputs.app }}
          SELENIUM_CHANGED: ${{ needs.changes-detect.outputs.selenium }}
          CYPRESS_CHANGED: ${{ needs.changes-detect.outputs.cypress }}
          PLAYWRIGHT_CHANGED: ${{ needs.changes-detect.outputs.playwright }}
          COMPOSE_CHANGED: ${{ needs.changes-detect.outputs.compose }}
          WORKFLOW_CHANGED: ${{ needs.changes-detect.outputs.workflow }}
          BUILD_APP_RESULT: ${{ needs.build-app.result }}
          SELENIUM_RESULT: ${{ needs.test-selenium.result }}
          CYPRESS_RESULT: ${{ needs.test-cypress.result }}
          PLAYWRIGHT_RESULT: ${{ needs.test-playwright.result }}
        run: |
          set -euo pipefail

          require_build_app=false
          require_selenium=false
          require_cypress=false
          require_playwright=false

          if [[ "$APP_CHANGED" == "true" || "$SELENIUM_CHANGED" == "true" || "$CYPRESS_CHANGED" == "true" || "$PLAYWRIGHT_CHANGED" == "true" || "$COMPOSE_CHANGED" == "true" || "$WORKFLOW_CHANGED" == "true" ]]; then
            require_build_app=true
          fi

          if [[ "$SELENIUM_CHANGED" == "true" || "$COMPOSE_CHANGED" == "true" || "$WORKFLOW_CHANGED" == "true" ]]; then
            require_selenium=true
          fi

          if [[ "$CYPRESS_CHANGED" == "true" || "$COMPOSE_CHANGED" == "true" || "$WORKFLOW_CHANGED" == "true" ]]; then
            require_cypress=true
          fi

          if [[ "$PLAYWRIGHT_CHANGED" == "true" || "$COMPOSE_CHANGED" == "true" || "$WORKFLOW_CHANGED" == "true" ]]; then
            require_playwright=true
          fi

          fail=0
          if [[ "$require_build_app" == "true" && "$BUILD_APP_RESULT" != "success" ]]; then
            echo "Required job build-app did not succeed (result: $BUILD_APP_RESULT)"
            fail=1
          fi
          if [[ "$require_selenium" == "true" && "$SELENIUM_RESULT" != "success" ]]; then
            echo "Required job test-selenium did not succeed (result: $SELENIUM_RESULT)"
            fail=1
          fi
          if [[ "$require_cypress" == "true" && "$CYPRESS_RESULT" != "success" ]]; then
            echo "Required job test-cypress did not succeed (result: $CYPRESS_RESULT)"
            fail=1
          fi
          if [[ "$require_playwright" == "true" && "$PLAYWRIGHT_RESULT" != "success" ]]; then
            echo "Required job test-playwright did not succeed (result: $PLAYWRIGHT_RESULT)"
            fail=1
          fi

          exit $fail

  auto-merge-to-main:
    needs: [ci-summary]
    if: github.event_name == 'pull_request' && github.base_ref == 'main' && needs.ci-summary.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
