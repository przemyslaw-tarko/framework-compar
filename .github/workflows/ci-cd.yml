name: CI/CD - App + Tests

on:
  push:
    branches: [main]
    paths:
      - "app/**"
      - "selenium/**"
      - "cypress/**"
      - "playwright/**"
      - "docker-compose.tests.yml"
      - ".github/workflows/ci-cd.yml"
  pull_request:
    branches: [main]
    paths:
      - "app/**"
      - "selenium/**"
      - "cypress/**"
      - "playwright/**"
      - "docker-compose.tests.yml"
      - ".github/workflows/ci-cd.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Build app container
        run: |
          docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml pull --quiet

      - name: Smoke check app
        run: |
          docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml up -d --quiet-pull
          for i in {1..30}; do
            curl -fsS -o /dev/null http://localhost:8080/wp-login.php && exit 0
            sleep 5
          done
          echo "App did not become ready in time" >&2
          exit 1

      - name: Teardown app
        if: always()
        run: |
          docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml down --remove-orphans || true

  test-selenium:
    needs: [build-app]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Start app stack
        run: docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml up -d --quiet-pull

      - name: Wait for app
        run: |
          for i in {1..30}; do
            curl -fsS -o /dev/null http://localhost:8080/wp-login.php && exit 0
            sleep 5
          done
          echo "App did not become ready in time" >&2
          exit 1

      - name: Start Selenium Chrome
        run: docker compose -f docker-compose.tests.yml up -d --quiet-pull selenium-chrome

      - name: Run Selenium tests
        run: docker compose -f docker-compose.tests.yml run --rm selenium-tests

      - name: Upload Selenium result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-selenium-tests
          path: results/selenium
          if-no-files-found: error

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker-compose.tests.yml down --remove-orphans || true
          if [ -f app/test-bookstore/docker-test-bookstore/docker-compose.yml ]; then
            docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml down --remove-orphans || true
          fi

  test-cypress:
    needs: [build-app]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Start app stack
        run: docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml up -d --quiet-pull

      - name: Wait for app
        run: |
          for i in {1..30}; do
            curl -fsS -o /dev/null http://localhost:8080/wp-login.php && exit 0
            sleep 5
          done
          echo "App did not become ready in time" >&2
          exit 1

      - name: Run Cypress tests
        run: docker compose -f docker-compose.tests.yml run --rm cypress-tests

      - name: Upload Cypress result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-cypress-tests
          path: results/cypress
          if-no-files-found: error

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker-compose.tests.yml down --remove-orphans || true
          if [ -f app/test-bookstore/docker-test-bookstore/docker-compose.yml ]; then
            docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml down --remove-orphans || true
          fi

  test-playwright:
    needs: [build-app]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULES_TOKEN }}

      - name: Start app stack
        run: docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml up -d --quiet-pull

      - name: Wait for app
        run: |
          for i in {1..30}; do
            curl -fsS -o /dev/null http://localhost:8080/wp-login.php && exit 0
            sleep 5
          done
          echo "App did not become ready in time" >&2
          exit 1

      - name: Run Playwright tests
        run: docker compose -f docker-compose.tests.yml run --rm playwright-tests

      - name: Upload Playwright result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-playwright-tests
          path: results/playwright
          if-no-files-found: error

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker-compose.tests.yml down --remove-orphans || true
          if [ -f app/test-bookstore/docker-test-bookstore/docker-compose.yml ]; then
            docker compose -f app/test-bookstore/docker-test-bookstore/docker-compose.yml down --remove-orphans || true
          fi

  auto-merge-to-main:
    needs: [build-app, test-selenium, test-cypress, test-playwright]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          for i in 1 2 3 4 5 6; do
            if gh pr merge "$PR_NUMBER" --auto --squash; then
              echo "Auto-merge enabled for PR #$PR_NUMBER"
              exit 0
            fi
            echo "Auto-merge not enabled yet (attempt $i). Waiting..."
            sleep $((i * 10))
          done
          echo "Failed to enable auto-merge after retries. Check branch protection and repo settings."
          exit 0
